---
import Layout from "../layouts/Layout.astro";
import VehicleInventory from "../components/VehicleInventory";
import QuotationsPanel from "../components/QuotationsPanel";
import StatisticsPanel from "../components/StatisticsPanel";
import UserProfile from "../components/UserProfile";
import UsersManagement from "../components/UsersManagement";
import Settings from "../components/Settings";

// Esta p√°gina requiere autenticaci√≥n
// La verificaci√≥n se hace en el cliente
---

<Layout title="Dashboard - iCarSolutions">
  <div id="dashboard-content" class="min-h-screen bg-gray-50 py-12 px-4">
    <div class="max-w-7xl mx-auto">
      {/* Header */}
      <div class="flex justify-between items-center mb-8">
        <div>
          <h1 class="text-4xl font-bold text-gray-900">Dashboard</h1>
          <p class="text-gray-600 mt-2">Bienvenido, <span id="user-name">Usuario</span></p>
          <p class="text-sm text-gray-500">Rol: <span id="user-role" class="font-semibold"></span></p>
        </div>
        <button
          id="logout-btn"
          class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition"
        >
          Cerrar Sesi√≥n
        </button>
      </div>

      {/* Contenido din√°mico */}
      <div id="content-area">
        {/* Contenido por defecto - Dashboard principal */}
        <div id="default-view" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <a href="/vehicles" class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition cursor-pointer">
              <div class="text-4xl mb-4">üöó</div>
              <h3 class="text-xl font-bold text-gray-900 mb-2">Mis Veh√≠culos</h3>
              <p class="text-gray-600 mb-4">Administra tu inventario de veh√≠culos</p>
              <button class="text-blue-600 hover:underline font-semibold">Ver Inventario ‚Üí</button>
            </a>

            <a href="/quotations" class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition cursor-pointer">
              <div class="text-4xl mb-4">üìÑ</div>
              <h3 class="text-xl font-bold text-gray-900 mb-2">Cotizaciones</h3>
              <p class="text-gray-600 mb-4">Genera y descarga PDFs de cotizaciones</p>
              <button class="text-blue-600 hover:underline font-semibold">Ver Cotizaciones ‚Üí</button>
            </a>

            <a href="/statistics" class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition cursor-pointer">
              <div class="text-4xl mb-4">üìä</div>
              <h3 class="text-xl font-bold text-gray-900 mb-2">Estad√≠sticas</h3>
              <p class="text-gray-600 mb-4">Visualiza tus ventas y desempe√±o</p>
              <button class="text-blue-600 hover:underline font-semibold">Ver Gr√°ficos ‚Üí</button>
            </a>

            <a href="/profile" class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition cursor-pointer">
              <div class="text-4xl mb-4">üë§</div>
              <h3 class="text-xl font-bold text-gray-900 mb-2">Mi Perfil</h3>
              <p class="text-gray-600 mb-4">Actualiza tu informaci√≥n personal</p>
              <button class="text-blue-600 hover:underline font-semibold">Editar Perfil ‚Üí</button>
            </a>

            <a href="/users" class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition cursor-pointer">
              <div class="text-4xl mb-4">üë•</div>
              <h3 class="text-xl font-bold text-gray-900 mb-2">Usuarios</h3>
              <p class="text-gray-600 mb-4">Gestiona usuarios del sistema</p>
              <button class="text-blue-600 hover:underline font-semibold">Ver Usuarios ‚Üí</button>
            </a>

            <a href="/settings" class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition cursor-pointer">
              <div class="text-4xl mb-4">‚öôÔ∏è</div>
              <h3 class="text-xl font-bold text-gray-900 mb-2">Configuraci√≥n</h3>
              <p class="text-gray-600 mb-4">Ajusta configuraci√≥n de la cuenta</p>
              <button class="text-blue-600 hover:underline font-semibold">Configurar ‚Üí</button>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { supabase } from "../utils/supabase";

  // Verificar autenticaci√≥n al cargar la p√°gina
  async function checkAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    
    if (!session) {
      // No hay sesi√≥n, redirigir al login
      window.location.href = "/admin";
      return;
    }

    // Obtener datos del usuario
    const { data: userData, error } = await supabase
      .from("users")
      .select("*")
      .eq("id", session.user.id)
      .single();

    if (error || !userData) {
      console.error("Error obteniendo datos del usuario:", error);
      window.location.href = "/admin";
      return;
    }

    // Actualizar UI con datos del usuario
    const userNameEl = document.getElementById("user-name");
    const userRoleEl = document.getElementById("user-role");
    
    if (userNameEl) userNameEl.textContent = userData.nombre;
    if (userRoleEl) userRoleEl.textContent = userData.rol;
  }

  // Logout handler
  document.getElementById("logout-btn")?.addEventListener("click", async () => {
    const { error } = await supabase.auth.signOut();
    
    if (error) {
      console.error("Error al cerrar sesi√≥n:", error);
      alert("Error al cerrar sesi√≥n");
      return;
    }
    
    window.location.href = "/admin";
  });

  // Ejecutar verificaci√≥n al cargar
  checkAuth();
</script>
