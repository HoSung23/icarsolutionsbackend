---
import Layout from "../layouts/Layout.astro";
import VehicleInventory from "../components/VehicleInventory";
import QuotationsPanel from "../components/QuotationsPanel";
import StatisticsPanel from "../components/StatisticsPanel";
import UserProfile from "../components/UserProfile";
import UsersManagement from "../components/UsersManagement";
import Settings from "../components/Settings";

// Esta p√°gina requiere autenticaci√≥n
// La verificaci√≥n se hace en el cliente
---

<Layout title="Dashboard - iCarSolutions">
  <div id="dashboard-content" class="min-h-screen bg-gray-50 py-12 px-4">
    <div class="max-w-7xl mx-auto">
      {/* Header */}
      <div class="flex justify-between items-center mb-8">
        <div>
          <h1 class="text-4xl font-bold text-gray-900">Dashboard</h1>
          <p class="text-gray-600 mt-2">Bienvenido, <span id="user-name">Usuario</span></p>
          <p class="text-sm text-gray-500">Rol: <span id="user-role" class="font-semibold"></span></p>
        </div>
        <button
          id="logout-btn"
          class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition"
        >
          Cerrar Sesi√≥n
        </button>
      </div>

      {/* Contenido din√°mico */}
      <div id="content-area">
        {/* Contenido por defecto - Dashboard principal */}
        <div id="default-view" class="space-y-6">
          <div id="dashboard-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {/* Las cards se cargar√°n din√°micamente seg√∫n el rol */}
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { supabase } from "../utils/supabase";

  // Definir permisos por rol
  const rolePermissions = {
    cliente: [
      { icon: "üë§", title: "Mi Perfil", description: "Actualiza tu informaci√≥n personal", link: "/profile" },
      { icon: "‚öôÔ∏è", title: "Configuraci√≥n", description: "Ajusta configuraci√≥n de tu cuenta", link: "/settings" }
    ],
    vendedor: [
      { icon: "üë§", title: "Mi Perfil", description: "Actualiza tu informaci√≥n personal", link: "/profile" },
      { icon: "üöó", title: "Veh√≠culos", description: "Administra el inventario de veh√≠culos", link: "/vehicles" },
      { icon: "üîß", title: "Repuestos", description: "Gestiona cat√°logo de repuestos", link: "/spare-parts" },
      { icon: "üìÖ", title: "Citas", description: "Gestiona citas de servicio", link: "/dashboard/appointments" },
      { icon: "‚öôÔ∏è", title: "Configuraci√≥n", description: "Ajusta configuraci√≥n de tu cuenta", link: "/settings" }
    ],
    admin: [
      { icon: "üöó", title: "Veh√≠culos", description: "Administra el inventario de veh√≠culos", link: "/vehicles" },
      { icon: "ÔøΩ", title: "Repuestos", description: "Gestiona cat√°logo de repuestos", link: "/spare-parts" },
      { icon: "üìÖ", title: "Citas", description: "Gestiona citas de servicio", link: "/dashboard/appointments" },
      { icon: "ÔøΩüìÑ", title: "Cotizaciones", description: "Genera y descarga PDFs de cotizaciones", link: "/quotations" },
      { icon: "üìä", title: "Estad√≠sticas", description: "Visualiza ventas y desempe√±o", link: "/statistics" },
      { icon: "üë§", title: "Mi Perfil", description: "Actualiza tu informaci√≥n personal", link: "/profile" },
      { icon: "üë•", title: "Usuarios", description: "Gestiona usuarios del sistema", link: "/users" },
      { icon: "‚öôÔ∏è", title: "Configuraci√≥n", description: "Ajusta configuraci√≥n del sistema", link: "/settings" }
    ],
    gerente: [
      { icon: "üöó", title: "Veh√≠culos", description: "Administra el inventario de veh√≠culos", link: "/vehicles" },
      { icon: "ÔøΩ", title: "Repuestos", description: "Gestiona cat√°logo de repuestos", link: "/spare-parts" },
      { icon: "üìÖ", title: "Citas", description: "Gestiona citas de servicio", link: "/dashboard/appointments" },
      { icon: "ÔøΩüìÑ", title: "Cotizaciones", description: "Genera y descarga PDFs de cotizaciones", link: "/quotations" },
      { icon: "üìä", title: "Estad√≠sticas", description: "Visualiza ventas y desempe√±o", link: "/statistics" },
      { icon: "üë§", title: "Mi Perfil", description: "Actualiza tu informaci√≥n personal", link: "/profile" },
      { icon: "üë•", title: "Usuarios", description: "Gestiona usuarios del sistema", link: "/users" },
      { icon: "‚öôÔ∏è", title: "Configuraci√≥n", description: "Ajusta configuraci√≥n del sistema", link: "/settings" }
    ],
    superadmin: [
      { icon: "üöó", title: "Veh√≠culos", description: "Administra el inventario de veh√≠culos", link: "/vehicles" },
      { icon: "ÔøΩ", title: "Repuestos", description: "Gestiona cat√°logo de repuestos", link: "/spare-parts" },
      { icon: "üìÖ", title: "Citas", description: "Gestiona citas de servicio", link: "/dashboard/appointments" },
      { icon: "ÔøΩüìÑ", title: "Cotizaciones", description: "Genera y descarga PDFs de cotizaciones", link: "/quotations" },
      { icon: "üìä", title: "Estad√≠sticas", description: "Visualiza ventas y desempe√±o", link: "/statistics" },
      { icon: "üë§", title: "Mi Perfil", description: "Actualiza tu informaci√≥n personal", link: "/profile" },
      { icon: "üë•", title: "Usuarios", description: "Gestiona usuarios del sistema", link: "/users" },
      { icon: "‚öôÔ∏è", title: "Configuraci√≥n", description: "Ajusta configuraci√≥n del sistema", link: "/settings" }
    ]
  };

  // Verificar autenticaci√≥n al cargar la p√°gina
  async function checkAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    
    if (!session) {
      // No hay sesi√≥n, redirigir al login
      window.location.href = "/login";
      return;
    }

    // Obtener datos del usuario
    const { data: userData, error } = await supabase
      .from("users")
      .select("*")
      .eq("id", session.user.id)
      .single();

    if (error || !userData) {
      console.error("Error obteniendo datos del usuario:", error);
      window.location.href = "/login";
      return;
    }

    // Actualizar UI con datos del usuario
    const userNameEl = document.getElementById("user-name");
    const userRoleEl = document.getElementById("user-role");
    
    if (userNameEl) userNameEl.textContent = userData.nombre;
    if (userRoleEl) userRoleEl.textContent = userData.rol;

    // Renderizar dashboard seg√∫n rol
    renderDashboard(userData.rol);
  }

  // Renderizar cards del dashboard seg√∫n el rol
  function renderDashboard(role: string) {
    const dashboardCards = document.getElementById("dashboard-cards");
    if (!dashboardCards) return;

    // Obtener permisos para el rol (default a cliente si no existe)
    const permissions = rolePermissions[role] || rolePermissions.cliente;

    // Limpiar contenedor
    dashboardCards.innerHTML = "";

    // Crear cards
    permissions.forEach((card) => {
      const cardEl = document.createElement("a");
      cardEl.href = card.link;
      cardEl.className = "bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition cursor-pointer";
      cardEl.innerHTML = `
        <div class="text-4xl mb-4">${card.icon}</div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">${card.title}</h3>
        <p class="text-gray-600 mb-4">${card.description}</p>
        <button class="text-blue-600 hover:underline font-semibold">Acceder ‚Üí</button>
      `;
      dashboardCards.appendChild(cardEl);
    });
  }

  // Logout handler
  document.getElementById("logout-btn")?.addEventListener("click", async () => {
    const { error } = await supabase.auth.signOut();
    
    if (error) {
      console.error("Error al cerrar sesi√≥n:", error);
      alert("Error al cerrar sesi√≥n");
      return;
    }
    
    window.location.href = "/login";
  });

  // Ejecutar verificaci√≥n al cargar
  checkAuth();
</script>
