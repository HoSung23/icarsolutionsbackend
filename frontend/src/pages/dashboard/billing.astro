---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Facturación - iCarSolutions">
  <div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4">
      <div class="mb-6">
        <a href="/" class="text-blue-600 hover:underline">← Volver al inicio</a>
      </div>

      <div class="bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold mb-6">Facturación</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-blue-600 text-sm font-semibold">Órdenes en Ruta</p>
                <p class="text-3xl font-bold text-blue-900" id="ordenes-en-ruta">0</p>
              </div>
              <svg class="w-12 h-12 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
            </div>
          </div>

          <div class="bg-green-50 border border-green-200 rounded-lg p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-green-600 text-sm font-semibold">Órdenes Entregadas</p>
                <p class="text-3xl font-bold text-green-900" id="ordenes-entregadas">0</p>
              </div>
              <svg class="w-12 h-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          </div>
        </div>

        <div class="mb-6">
          <h2 class="text-xl font-bold mb-4">Historial de Facturas</h2>
        </div>
        
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 border-b">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Factura #</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Fecha</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Descripción</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Monto</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Estado</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Acción</th>
              </tr>
            </thead>
            <tbody id="facturas-tbody">
              <tr>
                <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                  Cargando facturas...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from "../../utils/supabase";

    async function loadBilling() {
      const tbody = document.getElementById("facturas-tbody");
      const ordenesEnRutaEl = document.getElementById("ordenes-en-ruta");
      const ordenesEntregadasEl = document.getElementById("ordenes-entregadas");

      if (!tbody) return;

      try {
        const authSession = localStorage.getItem("auth_session");
        if (!authSession) {
          tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-red-500">Debes iniciar sesión.</td></tr>';
          return;
        }

        const user = JSON.parse(authSession);

        const { data: cotizaciones, error } = await supabase
          .from("cotizaciones")
          .select(`
            *,
            vehicles (
              marca,
              modelo_año,
              precio
            )
          `)
          .eq("user_id", user.id)
          .order("created_at", { ascending: false });

        if (error) throw error;

        if (!cotizaciones || cotizaciones.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">No tienes facturas todavía.</td></tr>';
          return;
        }

        // Calcular estadísticas
        const enRuta = cotizaciones.filter((c) => c.estado === "en_ruta" || c.estado === "aprobada");
        const entregadas = cotizaciones.filter((c) => c.estado === "entregada");

        if (ordenesEnRutaEl) ordenesEnRutaEl.textContent = enRuta.length.toString();
        if (ordenesEntregadasEl) ordenesEntregadasEl.textContent = entregadas.length.toString();

        tbody.innerHTML = cotizaciones
          .map(
            (factura) => `
          <tr class="border-b hover:bg-gray-50">
            <td class="px-4 py-3 font-mono text-sm">#${factura.id.slice(0, 8)}</td>
            <td class="px-4 py-3 text-sm">${new Date(factura.created_at).toLocaleDateString("es-GT")}</td>
            <td class="px-4 py-3 text-sm">${factura.vehicles?.marca || "Vehículo"} ${factura.vehicles?.modelo_año || ""}</td>
            <td class="px-4 py-3 text-sm font-bold">QTZ ${factura.vehicles?.precio?.toLocaleString() || "N/A"}</td>
            <td class="px-4 py-3">
              <span class="inline-block px-2 py-1 rounded text-xs font-semibold ${
                factura.estado === "entregada"
                  ? "bg-green-100 text-green-800"
                  : factura.estado === "en_ruta" || factura.estado === "aprobada"
                  ? "bg-blue-100 text-blue-800"
                  : factura.estado === "rechazada"
                  ? "bg-red-100 text-red-800"
                  : "bg-yellow-100 text-yellow-800"
              }">
                ${
                  factura.estado === "entregada" ? "Entregada" : 
                  factura.estado === "en_ruta" ? "En Ruta" :
                  factura.estado === "aprobada" ? "En Ruta" :
                  factura.estado === "pendiente" ? "Pendiente" : 
                  "Rechazada"
                }
              </span>
            </td>
            <td class="px-4 py-3">
              ${
                factura.estado === "entregada"
                  ? '<button class="text-blue-600 hover:underline text-sm" onclick="alert(\'Función de descarga próximamente\')">Descargar PDF</button>'
                  : '<span class="text-gray-400 text-sm">N/A</span>'
              }
            </td>
          </tr>
        `
          )
          .join("");
      } catch (error) {
        console.error("Error cargando billing:", error);
        tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-red-500">Error al cargar facturas.</td></tr>';
      }
    }

    loadBilling();
  </script>
</Layout>
