---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Mis √ìrdenes - iCarSolutions">
  <div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4">
      <div class="mb-6">
        <a href="/" class="text-blue-600 hover:underline">‚Üê Volver al inicio</a>
      </div>

      <div class="bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold mb-6">Mis √ìrdenes</h1>
        
        <div class="space-y-4" id="ordenes-container">
          <p class="text-gray-500">Cargando √≥rdenes...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from "../../utils/supabase";

    async function loadOrdenes() {
      const container = document.getElementById("ordenes-container");
      if (!container) return;

      try {
        // Obtener usuario actual
        const authSession = localStorage.getItem("auth_session");
        if (!authSession) {
          container.innerHTML = '<p class="text-red-500">Debes iniciar sesi√≥n para ver tus √≥rdenes.</p>';
          return;
        }

        const user = JSON.parse(authSession);

        // Obtener cotizaciones/√≥rdenes del usuario
        const { data: cotizaciones, error } = await supabase
          .from("cotizaciones")
          .select(`
            *,
            vehicles (
              marca,
              modelo_a√±o,
              precio,
              imagenes
            )
          `)
          .eq("user_id", user.id)
          .order("created_at", { ascending: false });

        if (error) throw error;

        if (!cotizaciones || cotizaciones.length === 0) {
          container.innerHTML = '<p class="text-gray-500">No tienes √≥rdenes todav√≠a.</p>';
          return;
        }

        container.innerHTML = cotizaciones
          .map(
            (orden) => `
          <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition">
            <div class="flex items-start justify-between">
              <div class="flex gap-4">
                ${
                  orden.vehicles?.imagenes?.[0]
                    ? `<img src="${orden.vehicles.imagenes[0]}" alt="Veh√≠culo" class="w-24 h-24 object-cover rounded" />`
                    : '<div class="w-24 h-24 bg-gray-200 rounded flex items-center justify-center text-4xl">üöó</div>'
                }
                <div>
                  <h3 class="font-bold text-lg">${orden.vehicles?.marca || "Veh√≠culo"} ${orden.vehicles?.modelo_a√±o || ""}</h3>
                  <p class="text-gray-600">Orden #${orden.id.slice(0, 8)}</p>
                  <p class="text-sm text-gray-500">Fecha: ${new Date(orden.created_at).toLocaleDateString("es-GT")}</p>
                  <p class="text-blue-600 font-bold mt-2">QTZ ${orden.vehicles?.precio?.toLocaleString() || "N/A"}</p>
                </div>
              </div>
              <div>
                <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold ${
                  orden.estado === "aprobada"
                    ? "bg-green-100 text-green-800"
                    : orden.estado === "rechazada"
                    ? "bg-red-100 text-red-800"
                    : "bg-yellow-100 text-yellow-800"
                }">
                  ${orden.estado === "pendiente" ? "Pendiente" : orden.estado === "aprobada" ? "Aprobada" : "Rechazada"}
                </span>
              </div>
            </div>
            ${
              orden.comentarios
                ? `<div class="mt-4 pt-4 border-t border-gray-200">
                <p class="text-sm text-gray-600"><strong>Comentarios:</strong> ${orden.comentarios}</p>
              </div>`
                : ""
            }
          </div>
        `
          )
          .join("");
      } catch (error) {
        console.error("Error cargando √≥rdenes:", error);
        container.innerHTML = '<p class="text-red-500">Error al cargar las √≥rdenes.</p>';
      }
    }

    loadOrdenes();
  </script>
</Layout>
